<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard de Ocupaciones – RN & PAX</title>
https://cdn.jsdelivr.net
<style>
  :root{
    --azul:#0c2b4b; --azul-suave:#1c3f63; --dorado:#c9a063; --bg:#f5f6fa; --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#233}
  header{background:var(--azul);color:#fff;padding:22px 16px}
  header h1{margin:0;font-weight:600;letter-spacing:.3px;font-size:22px}
  header p{margin:6px 0 0 0;opacity:.85}
  .wrap{max-width:1200px;margin:20px auto;padding:0 14px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);margin:16px 0;padding:18px}
  .card h2{margin:0 0 12px 0;color:var(--azul);font-weight:600;border-left:6px solid var(--dorado);padding-left:10px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  label{display:block;font-weight:600;color:var(--azul-suave);margin:8px 0 6px}
  select,button{width:100%;padding:10px 12px;border:1px solid #ccd;border-radius:10px;background:#fff}
  button{background:var(--azul);color:#fff;border:none;cursor:pointer;font-weight:600}
  button:hover{background:var(--dorado);color:var(--azul)}
  .status{padding:10px 12px;border-radius:10px;background:#eef3ff;border:1px solid #dde6ff;color:#10305f}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px}
  .kpi{background:#0c2b4b08;border-left:5px solid var(--azul);border-radius:10px;padding:12px 14px}
  .kpi h3{margin:0;color:var(--azul-suave);font-size:13px;text-transform:uppercase;letter-spacing:.5px}
  .kpi .v{font-size:22px;font-weight:800;margin-top:6px}
  canvas{max-height:380px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee}
  th{background:#fafafa;text-align:left}
  .muted{opacity:.75}
  .filters{display:flex;gap:10px;flex-wrap:wrap}
  .filter-chip{background:#eef3ff;border:1px solid #dde6ff;color:#10305f;border-radius:999px;padding:6px 10px;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>Dashboard de Ocupaciones – RN & PAX</h1>
  <p>Carga automática de <strong>OCUPACIONES.xlsx</strong> desde el repositorio. Estructura esperada: <code>Month_Name</code>, <code>Complejo</code>, <code>RN</code>, <code>PAX</code>. <!-- columnas comprobadas en tu fichero --> </p>
</header>

<div class="wrap">

  <!-- ESTADO DE CARGA -->
  <div class="card">
    <div id="status" class="status">Cargando datos desde <code>OCUPACIONES.xlsx</code>…</div>
  </div>

  <!-- FILTROS -->
  <div class="card hidden" id="filtrosCard">
    <h2>1) Filtros</h2>
    <div class="row">
      <div class="col">
        <label>Meses</label>
        <select id="selMeses" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Hoteles</label>
        <select id="selHoteles" multiple size="10"></select>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="btnReset">Quitar filtros</button>
      </div>
    </div>
    <div id="chips" class="filters" style="margin-top:10px"></div>
  </div>

  <!-- KPIS -->
  <div class="card hidden" id="kpisCard">
    <h2>2) KPIs</h2>
    <div class="kpis">
      <div class="kpi"><h3>RN Totales</h3><div class="v" id="kpiRN">–</div></div>
      <div class="kpi"><h3>PAX Totales</h3><div class="v" id="kpiPAX">–</div></div>
      <div class="kpi"><h3>PAX/RN</h3><div class="v" id="kpiPR">–</div></div>
      <div class="kpi"><h3>Nº Hoteles</h3><div class="v" id="kpiN">–</div></div>
    </div>
  </div>

  <!-- GRÁFICOS -->
  <div class="card hidden" id="chartsCard">
    <h2>3) Gráficos</h2>
    <div class="row">
      <div class="col"><canvas id="chartMeses"></canvas></div>
      <div class="col"><canvas id="chartTop"></canvas></div>
    </div>
  </div>

  <!-- RANKING -->
  <div class="card hidden" id="rankingCard">
    <h2>4) Ranking por hotel</h2>
    <div style="overflow:auto">
      <table id="tblRanking">
        <thead>
          <tr><th>#</th><th>Hotel</th><th>RN</th><th>PAX</th><th>PAX/RN</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col"><button id="btnCsv">Descargar CSV (filtrado)</button></div>
      <div class="col"><button id="btnXlsx">Descargar Excel (filtrado)</button></div>
    </div>
  </div>

  <div class="muted">© ONA Hotels · Herramienta interna de análisis — generado por M365 Copilot</div>
</div>

<!-- Librerías -->
https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.t.umd.min.js</script>

<script>
  // ======= ESTADO GLOBAL =======
  let raw = [];        // Datos completos (incluye filas 'Total')
  let filtered = [];   // Datos filtrados (por mes/hotel)
  let chartMeses, chartTop;
  const MESES_ORD = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

  const el = (id) => document.getElementById(id);
  const show = (id) => el(id).classList.remove('hidden');

  // ======= CARGA AUTOMÁTICA DEL XLSX DESDE EL REPO =======
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const url = 'OCUPACIONES.xlsx'; // Debe existir en la misma carpeta del index.html
      const status = el('status');
      status.textContent = 'Descargando OCUACIONES.xlsx…';

      const res = await fetch(url);
      if(!res.ok) throw new Error('No se pudo descargar el archivo (' + res.status + ')');

      status.textContent = 'Leyendo Excel…';
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const sh = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sh, {defval:null});

      // Normalización a las 4 columnas esperadas (Month_Name, Complejo, RN, PAX)
      raw = json.map(r => ({
        Month_Name: String(r['Month_Name'] ?? r['Mes'] ?? r['month'] ?? '').trim(),
        Complejo:   String(r['Complejo']   ?? r['Hotel'] ?? r['Property'] ?? '').trim(),
        RN:   Number(r['RN']   ?? r['RN Totales'] ?? r['RoomNights'] ?? 0) || 0,
        PAX:  Number(r['PAX']  ?? r['Pax']        ?? r['Guests']     ?? 0) || 0
      })).filter(r => r.Month_Name && r.Complejo);

      status.textContent = `Datos cargados: ${raw.length.toLocaleString('es-ES')} filas.`;

      // Construye UI
      buildFilters();
      applyFilters();

      // Muestra tarjetas
      show('filtrosCard'); show('kpisCard'); show('chartsCard'); show('rankingCard');

    } catch(err) {
      el('status').innerHTML = '❌ Error al cargar <code>OCUPACIONES.xlsx</code>: ' + (err.message || err);
    }
  });

  // ======= FILTROS =======
  const selMeses = el('selMeses');
  const selHoteles = el('selHoteles');
  el('btnReset').addEventListener('click', () => {
    selMeses.selectedIndex = -1; selHoteles.selectedIndex = -1; applyFilters();
  });

  selMeses.addEventListener('change', applyFilters);
  selHoteles.addEventListener('change', applyFilters);

  function buildFilters(){
    // Meses (orden natural)
    selMeses.innerHTML = '';
    MESES_ORD.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m; selMeses.appendChild(opt);
    });

    // Hoteles (alfabético) – sin deduplicar 'Total' porque ya no estará en ranking
    selHoteles.innerHTML = '';
    const hoteles = [...new Set(raw.map(r => r.Complejo))].sort((a,b)=>a.localeCompare(b,'es'));
    hoteles.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h; opt.textContent = h; selHoteles.appendChild(opt);
    });
  }

  function getSelectedValues(sel){
    return Array.from(sel.selectedOptions).map(o => o.value);
  }

  function applyFilters(){
    const meses = getSelectedValues(selMeses);
    const hoteles = getSelectedValues(selHoteles);

    filtered = raw.filter(r =>
      (meses.length   ? meses.includes(r.Month_Name) : true) &&
      (hoteles.length ? hoteles.includes(r.Complejo) : true)
    );

    renderChips(meses, hoteles);
    updateKPIs();
    updateCharts();
    renderRanking();
  }

  function renderChips(meses, hoteles){
    const div = el('chips');
    const chips = [];
    if(meses.length) chips.push(`<span class="filter-chip">Meses: ${meses.join(', ')}</span>`);
    if(hoteles.length) chips.push(`<span class="filter-chip">Hoteles: ${hoteles.slice(0,6).join(', ')}${hoteles.length>6?'…':''}</span>`);
    div.innerHTML = chips.join('');
  }

  // ======= KPI / AGRUPACIONES =======
  const sum = (arr, key) => arr.reduce((a,b)=>a+(b[key]||0),0);

  function updateKPIs(){
    const rn = sum(filtered,'RN');
    const px = sum(filtered,'PAX');
    const pr = rn ? (px/rn) : 0;
    const nHoteles = new Set(filtered.map(r => r.Complejo)).size;
    el('kpiRN').textContent = rn.toLocaleString('es-ES');
    el('kpiPAX').textContent = px.toLocaleString('es-ES');
    el('kpiPR').textContent = pr.toFixed(2);
    el('kpiN').textContent = nHoteles;
  }

  function groupByMonth(data){
    const map = new Map();
    data.forEach(r => {
      const k = r.Month_Name;
      if(!map.has(k)) map.set(k, {Month_Name:k, RN:0, PAX:0});
      const o = map.get(k); o.RN += r.RN; o.PAX += r.PAX;
    });
    return Array.from(map.values()).sort(
      (a,b) => MESES_ORD.indexOf(a.Month_Name) - MESES_ORD.indexOf(b.Month_Name)
    );
  }

  function groupByHotel(data){
    const map = new Map();
    data.forEach(r => {
      const k = r.Complejo;
      if(!map.has(k)) map.set(k, {Hotel:k, RN:0, PAX:0});
      const o = map.get(k); o.RN += r.RN; o.PAX += r.PAX;
    });
    // Excluir los 'Total' del ranking por hotel
    const rows = Array.from(map.values()).filter(x => x.Hotel.toLowerCase() !== 'total');
    rows.sort((a,b)=> b.RN - a.RN);
    return rows;
  }

  // ======= GRÁFICOS =======
  function updateCharts(){
    const byM = groupByMonth(filtered);
    const labels = byM.map(d=>d.Month_Name);
    const dsRN = byM.map(d=>d.RN);
    const dsP  = byM.map(d=>d.PAX);

    const ctx1 = document.getElementById('chartMeses');
    if(chartMeses) chartMeses.destroy();
    chartMeses = new Chart(ctx1, {
      type:'line',
      data:{ labels, datasets:[
        {label:'RN', data:dsRN, borderColor:'#0c2b4b', backgroundColor:'rgba(12,43,75,.08)', tension:.25, fill:true},
        {label:'PAX', data:dsP,  borderColor:'#c9a063', backgroundColor:'rgba(201,160,99,.10)', tension:.25, fill:true}
      ]},
      options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{ y:{beginAtZero:true} } }
    });

    const byH = groupByHotel(filtered).slice(0,10);
    const ctx2 = document.getElementById('chartTop');
    if(chartTop) chartTop.destroy();
    chartTop = new Chart(ctx2, {
      type:'bar',
      data:{ labels: byH.map(d=>d.Hotel), datasets:[
        {label:'RN',  data: byH.map(d=>d.RN),  backgroundColor:'#0c2b4b'},
        {label:'PAX', data: byH.map(d=>d.PAX), backgroundColor:'#c9a063'}
      ]},
      options:{ indexAxis:'y', responsive:true, plugins:{legend:{position:'bottom'}}, scales:{x:{beginAtZero:true}} }
    });
  }

  // ======= RANKING =======
  function renderRanking(){
    const tbody = document.querySelector('#tblRanking tbody');
    const rows = groupByHotel(filtered);
    tbody.innerHTML = rows.map((r,i)=>(
      `<tr>
        <td>${i+1}</td>
        <td>${escapeHtml(r.Hotel)}</td>
        <td>${r.RN.toLocaleString('es-ES')}</td>
        <td>${r.PAX.toLocaleString('es-ES')}</td>
        <td>${(r.PAX/(r.RN||1)).toFixed(2)}</td>
      </tr>`
    )).join('');
  }

  // ======= EXPORTACIONES =======
  el('btnCsv').addEventListener('click', downloadCSV);
  el('btnXlsx').addEventListener('click', downloadXLSX);

  function downloadCSV(){
    const rows = filtered.map(r=>({Mes:r.Month_Name, Hotel:r.Complejo, RN:r.RN, PAX:r.PAX, PAX_por_RN: (r.PAX/(r.RN||1)).toFixed(2)}));
    const header = Object.keys(rows[0] || {Mes:'',Hotel:'',RN:'',PAX:'',PAX_por_RN:''}).join(',');
    const body = rows.map(r=>Object.values(r).join(',')).join('\n');
    const blob = new Blob([header+'\n'+body], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ocupaciones_filtrado.csv'; a.click();
  }

  function downloadXLSX(){
    const rows = filtered.map(r=>({Mes:r.Month_Name, Hotel:r.Complejo, RN:r.RN, PAX:r.PAX, PAX_por_RN: Number((r.PAX/(r.RN||1)).toFixed(2))}));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Filtrado');
    XLSX.writeFile(wb, 'ocupaciones_filtrado.xlsx');
  }

  // Utilidad
  function escapeHtml(s){ return s.replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c])); }
</script>
</body>
</html>
